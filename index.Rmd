---
title: "Correlation Environmental and fishery sea urchin data"
subtitle: "Suplementary analysis to Stock Assessment Sea Urchin 2024"
author: "Mauricio Mardones I"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
format:
  html:
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    embed-resources: true
    code-tools: true
    toc: true
    toc-float: true
    toc-depth: 4
    link-citations: yes
linkcolor: blue
bibliography: env_seaurchin.bib
csl: apa.csl
---

```{r setup, include=FALSE, message=F}
rm(list = ls())
options(bitmapType = "cairo") 
#XQuartz is a mess, put this in your onload to default to cairo instead (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
# solo para IOs
```


```{r setup2, include=FALSE, message=F}
knitr::opts_chunk$set(collapse = TRUE, 
                      comment = "  ", 
                      fig.align = 'center',
                      cache=FALSE,
                      warning = FALSE,
                      message = FALSE)
```


# ANTECEDENTES





Cargo librerías necesarias para el análisis exploratorio de los datos de las distintas bases de bitácora, tallas y biológico. 

```{r lib, message=F, echo= TRUE}
library(ncdf4)
library(raster)
library(sf)
library(leaflet)
library(lubridate)
library(rasterVis)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
```

@natural2023; @ncdf42021; @raster2022; @lubridate2011
```{r}
# A function for dotplots
multi_dotplot <- function(filename, Xvar, Yvar){
  filename %>%
    ggplot(aes(x = {{Xvar}})) +
    geom_point(aes(y = {{Yvar}}),
               alpha=0.4) +
    theme_bw() +
    coord_flip() +
    labs(x = "Order of Data")}
```


```{r}
ncfile <- "Data/global-analysis-forecast-bio-001-028-monthly_1693389410225.nc"

# Import NetCDF
nc <- nc_open(ncfile)

# Print information about the NetCDF file
print(nc)
```


```{r}
# import NetCDF with raster
chl_single <- raster(ncfile)
# print a summary of the raster
chl_single


# plot raster dataset
plot(chl_single)
```

```{r}
# import multi-band NetCDF file
chl_multi <- brick(ncfile)

# print a summary of the brick
chl_multi
```
```{r}
# plot brick dataset
levelplot(chl_multi)
```

```{r}
# calculate average and SD
chl_mean <- calc(chl_multi, fun = mean)
chl_sd <- calc(chl_multi, fun = sd)

#We can then explore the generated maps

# plot raster dataset
plot(chl_mean, main = "Average chl")
```

```{r}
plot(chl_sd, main = "Standard deviation chl")
```

```{r}
# convert raster to data.frame
chl_df <- as.data.frame(chl_mean, xy=TRUE, na.rm=TRUE)
```

Then, we will use the rnaturalearth package to download a global country map to use in the plot.

```{r}
# import countries layer from Natural Earth
countries <- ne_countries(scale = "medium", returnclass = "sf")
```

Finally, we use the ggplot() function from ggplot2 package to create a customized map. Note that each map component is added with a +. You can find further information about the ggplot2 package here.

```{r}
# plot
ggplot()+
  # add raster layer
  geom_raster(aes(x=x, y=y, fill=layer), data=chl_df) +
  # define color palette of raster layer
  scale_fill_distiller(palette = "Spectral", name = "chl (mgr)") + 
  # add countries layers
  geom_sf(fill=grey(0.9), color=grey(0.6), lwd = 0.2, data=countries) +
  # define spatial extent
  coord_sf(xlim = range(chl_df$x), ylim = range(chl_df$y), expand = F, ndiscr = 500) +
  # labels
  labs(title = "Mass concentration of chloropyll a in sea water(chl)",
       subtitle = "Annual average estimated from monthly products for 2020",
       x = "Longitude",
       y = "Latitude") +
  # theme
  theme_bw() 
```


# REFERENCIAS